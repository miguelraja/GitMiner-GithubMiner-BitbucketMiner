package aiss.gitminer.controller;

import aiss.gitminer.exception.NotFoundException;
import aiss.gitminer.model.Project;
import aiss.gitminer.repository.ProjectRepository;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.DisplayName;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;

import java.util.List;

import static org.junit.jupiter.api.Assertions.*;

@SpringBootTest
class ProjectControllerTest {

    @Autowired
    ProjectController projectController;

    @Autowired
    ProjectRepository projectRepository;

    private static Project project;

    @BeforeEach
    void setUp() throws JsonProcessingException {
        ObjectMapper mapper = new ObjectMapper();

        String projectData = "{\"id\":\"15717393\",\"name\":\"pitest\",\"web_url\":\"https://github.com/hcoles/pitest\",\"commits\":[{\"id\":\"ee6e291274fcca03801261f1fd0684aa32c6d140\",\"title\":\"Mergepullrequest#1150fromhcoles/feature/results_interceptors\",\"message\":\"\\n\\nNewextensionpoint\",\"author_name\":\"HenryColes\",\"author_email\":\"henry.coles@googlemail.com\",\"authored_date\":\"2023-01-25T13:06:19Z\",\"web_url\":\"https://github.com/hcoles/pitest/commit/ee6e291274fcca03801261f1fd0684aa32c6d140\"},{\"id\":\"95e8102725b59780c07e89d4fca9a7563f12c976\",\"title\":\"Newextensionpoints\",\"message\":\"\\n\\nAddsnewextensionpointstoallowpostanalysismodificationof\\ncoverageandmutationanalysisresults.\\n\\nExtensionspointshavemultiplepotentialuses,butfirstusecaseis\\nsupportingthe'un-inlining'ofinlinedkotlinfunctions.\\n\\nChangerequiresalterationofexistinginterfaceswhichmaybe\\nincompatiblewithsomethirdpartyplugins\",\"author_name\":\"HenryColes\",\"author_email\":\"henry@pitest.org\",\"authored_date\":\"2023-01-12T09:29:33Z\",\"web_url\":\"https://github.com/hcoles/pitest/commit/95e8102725b59780c07e89d4fca9a7563f12c976\"},{\"id\":\"598e5f1f4fd2c60e9153f0839f9ceab4d13bedbe\",\"title\":\"Mergepullrequest#1146fromdavidburstrom/davidburstrom-definition\",\"message\":\"\\n\\nFixspellingerrorinComputClassWrite\",\"author_name\":\"HenryColes\",\"author_email\":\"henry.coles@googlemail.com\",\"authored_date\":\"2023-01-20T18:17:08Z\",\"web_url\":\"https://github.com/hcoles/pitest/commit/598e5f1f4fd2c60e9153f0839f9ceab4d13bedbe\"},{\"id\":\"cef73029ab02ee4486a340b21877e4ec4e545c18\",\"title\":\"\",\"message\":\"UpdateComputeClassWriter.java\",\"author_name\":\"davidburstrom\",\"author_email\":\"david.burstrom@gmail.com\",\"authored_date\":\"2023-01-18T12:39:02Z\",\"web_url\":\"https://github.com/hcoles/pitest/commit/cef73029ab02ee4486a340b21877e4ec4e545c18\"}],\"issues\":[{\"id\":\"1556497126\",\"title\":\"Newextensionpoints\",\"description\":\"Addsnewextensionpointstoallowpostanalysismodificationofcoverageandmutationanalysisresults.\\r\\n\\r\\nExtensionspointshavemultiplepotentialuses,butfirstusecaseissupportingthe'un-inlining'ofinlinedkotlinfunctions.\\r\\n\\r\\nChangerequiresalterationofexistinginterfaceswhichmaybeincompatiblewithsomethirdpartyplugins.\",\"state\":\"closed\",\"created_at\":\"2023-01-25T11:35:30Z\",\"updated_at\":\"2023-01-25T13:06:20Z\",\"closed_at\":\"2023-01-25T13:06:19Z\",\"labels\":[],\"author\":{\"id\":\"1891135\",\"username\":\"hcoles\",\"name\":\"HenryColes\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/1891135?v=4\",\"web_url\":\"https://api.github.com/users/hcoles\"},\"assignee\":null,\"votes\":0,\"comments\":[]},{\"id\":\"1554713335\",\"title\":\"MissingAODoperator\",\"description\":\"Hello,\\r\\n\\r\\nI'vejustrunpitest1.10.4andconfiguredAODasfollows:\\r\\n\\r\\n```\\r\\n<pitest\\r\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tfeatures=\\\"+EXPORT\\\"\\r\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tpitClasspath=\\\"pitest.path\\\"\\r\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tthreads=\\\"2\\\"\\r\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tclassPath=\\\"mutation.path\\\"\\r\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\ttargetTests=\\\"org.util.*\\\"\\r\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\ttargetClasses=\\\"org.util.TriangleUtil\\\"\\r\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\treportDir=\\\"pitReports\\\"\\r\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tsourceDir=\\\"src\\\"\\r\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\tmutators=\\\"AOD\\\"\\r\\n\\t\\t\\t\\t\\t\\t\\t\\t\\t\\toutputFormats=\\\"HTML,CSV\\\"\\r\\n/>\\r\\n</target>\\r\\n```\\r\\n\\r\\nItgivesmethefollowing:\\r\\n`Exceptioninthread\\\"main\\\"org.pitest.help.PitHelpError:MutatororgroupAODisunknown.`\\r\\n\\r\\nItwasworkinginversion1.7.4,notsureaboutthefollowingones.\\r\\n\\r\\nThanks,\\r\\nF.\",\"state\":\"open\",\"created_at\":\"2023-01-24T10:30:10Z\",\"updated_at\":\"2023-01-24T11:19:41Z\",\"closed_at\":null,\"labels\":[],\"author\":{\"id\":\"5122337\",\"username\":\"pastoref\",\"name\":\"FabrizioPastore\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/5122337?v=4\",\"web_url\":\"https://api.github.com/users/pastoref\"},\"assignee\":null,\"votes\":0,\"web_url\":\"https://api.github.com/repos/hcoles/pitest/issues/1149\",\"comments\":[{\"id\":\"1401706648\",\"body\":\"Theresearchoperators(suchasAOD)weremovedintoanexternalpluginin1.7.5\\r\\n\\r\\nhttps://github.com/hcoles/pitest/releases/tag/1.7.5\",\"author\":{\"id\":\"1891135\",\"username\":\"hcoles\",\"name\":\"HenryColes\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/1891135?v=4\",\"web_url\":\"https://api.github.com/users/hcoles\"},\"created_at\":\"2023-01-24T10:35:17Z\",\"updated_at\":\"2023-01-24T10:35:17Z\"},{\"id\":\"1401764139\",\"body\":\"Thanksalotforthequickreplyandsorryforthefalsealarm.However,itseemstobeincompatiblewith1.10.*.\\r\\n\\r\\nMaybeyoucanmentionitalsoon\\\"https://pitest.org/quickstart/mutators/\\\"under\\\"ExperimentalMutators\\\"\\r\\n\\r\\nThankyou,\\r\\nF.P.\",\"author\":{\"id\":\"5122337\",\"username\":\"pastoref\",\"name\":\"FabrizioPastore\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/5122337?v=4\",\"web_url\":\"https://api.github.com/users/pastoref\"},\"created_at\":\"2023-01-24T11:19:40Z\",\"updated_at\":\"2023-01-24T11:19:40Z\"}]},{\"id\":\"1549280294\",\"title\":\"Coveragegenerationminionexitedabnormally!(UNKNOWN_ERROR)withv1.9.xand1.10.x\",\"description\":\"IhavethefollowingerrorwhenIrunPitestonmymicroservices:\\r\\n\\r\\n```\\r\\nClass,org.pitest.testapi.TestUnitExecutionListener)'ofinterfaceorg.pitest.testapi.TestUnitFinder.\\r\\n15:14:24PIT>>FINE:MINION:atorg.pitest.mutationtest.config.PrioritisingTestUnitFinder.findTestUnits(PrioritisingTestUnitFinder.java:20)\\r\\n15:14:24PIT>>INFO:MINION:15:14:24PIT>>SEVERE:Errorcalculatingcoverage.Processwillexit.\\r\\n15:14:24PIT>>FINE:MINION:atorg.pitest.testapi.execute.FindTestUnits.findTestUnits(FindTestUnits.java:64)\\r\\n15:14:24PIT>>SEVERE:CoveragegeneratorMinionexitedabnormallyduetoUNKNOWN_ERROR\\r\\n15:14:24PIT>>INFO:MINION:java.lang.AbstractMethodError:Receiverclassorg.pitest.junit5.JUnit5TestUnitFinderdoesnotdefineorinheritanimplementationoftheresolvedmethod'abstractjava.util.ListfindTestUnits(java.lang.Class,org.pitest.testapi.TestUnitExecutionListener)'ofinterfaceorg.pitest.testapi.TestUnitFinder.\\r\\n15:14:24PIT>>FINE:MINION:atorg.pitest.testapi.execute.FindTestUnits.getTestUnits(FindTestUnits.java:47)\\r\\n15:14:24PIT>>INFO:MINION:atorg.pitest.mutationtest.config.PrioritisingTestUnitFinder.findTestUnits(PrioritisingTestUnitFinder.java:20)\\r\\n15:14:24PIT>>FINE:MINION:atorg.pitest.testapi.execute.FindTestUnits.findTestUnitsForAllSuppliedClasses(FindTestUnits.java:36)\\r\\n15:14:24PIT>>INFO:MINION:atorg.pitest.testapi.execute.FindTestUnits.findTestUnits(FindTestUnits.java:64)\\r\\n[INFO]------------------------------------------------------------------------15:14:24PIT>>FINE:MINION:atorg.pitest.coverage.execute.CoverageMinion.discoverTests(CoverageMinion.java:167)\\r\\n15:14:24PIT>>INFO:MINION:atorg.pitest.testapi.execute.FindTestUnits.getTestUnits(FindTestUnits.java:47)\\r\\n15:14:24PIT>>FINE:MINION:atorg.pitest.coverage.execute.CoverageMinion.getTestsFromParent(CoverageMinion.java:153)\\r\\n[INFO]BUILDFAILURE15:14:24PIT>>INFO:MINION:atorg.pitest.testapi.execute.FindTestUnits.findTestUnitsForAllSuppliedClasses(FindTestUnits.java:36)\\r\\n15:14:24PIT>>FINE:MINION:atorg.pitest.coverage.execute.CoverageMinion.main(CoverageMinion.java:84)\\r\\n15:14:24PIT>>INFO:MINION:atorg.pitest.coverage.execute.CoverageMinion.discoverTests(CoverageMinion.java:167)\\r\\n[INFO]------------------------------------------------------------------------15:14:24PIT>>INFO:MINION:atorg.pitest.coverage.execute.CoverageMinion.getTestsFromParent(CoverageMinion.java:153)\\r\\n15:14:24PIT>>INFO:MINION:atorg.pitest.coverage.execute.CoverageMinion.main(CoverageMinion.java:84)\\r\\n[INFO]Totaltime:18.204s\\r\\n[INFO]Finishedat:2023-01-19T15:14:24+01:00\\r\\n[INFO]------------------------------------------------------------------------\\r\\n[ERROR]Failedtoexecutegoalorg.pitest:pitest-maven:1.10.4:mutationCoverage(default-cli)onprojecttd-ms:Executiondefault-cliofgoalorg.pitest:pitest-maven:1.10.4:mutationCoveragefailed:Coveragegenerationminionexitedabnormally!(UNKNOWN_ERROR)\\r\\n[ERROR]\\r\\n[ERROR]Pleasecopyandpastetheinformationandthecompletestacktracebelowwhenreportinganissue\\r\\n[ERROR]VM:OpenJDK64-BitServerVM\\r\\n[ERROR]Vendor:AzulSystems,Inc.\\r\\n[ERROR]Version:11.0.12+7-LTS\\r\\n[ERROR]Uptime:19079\\r\\n[ERROR]Input->\\r\\n[ERROR]1:-Dclassworlds.conf=C:\\\\Tools\\\\apache-maven-3.8.3\\\\bin\\\\m2.conf\\r\\n[ERROR]2:-Dmaven.home=C:\\\\Tools\\\\apache-maven-3.8.3\\r\\n[ERROR]3:-Dlibrary.jansi.path=C:\\\\Tools\\\\apache-maven-3.8.3\\\\lib\\\\jansi-native\\r\\n[ERROR]4:-Dmaven.multiModuleProjectDirectory=C:\\\\repositories\\\\IdeaProjects\\\\muse-ng\\\\td-ms\\r\\n[ERROR]BootClassPathSupported:false\\r\\n[ERROR]\\r\\n[ERROR]\\r\\n[ERROR]Pleasecopyandpastetheinformationandthecompletestacktracebelowwhenreportinganissue\\r\\n[ERROR]VM:OpenJDK64-BitServerVM\\r\\n[ERROR]Vendor:AzulSystems,Inc.\\r\\n[ERROR]Version:11.0.12+7-LTS\\r\\n[ERROR]Uptime:19080\\r\\n[ERROR]Input->\\r\\n[ERROR]1:-Dclassworlds.conf=C:\\\\Tools\\\\apache-maven-3.8.3\\\\bin\\\\m2.conf\\r\\n[ERROR]2:-Dmaven.home=C:\\\\Tools\\\\apache-maven-3.8.3\\r\\n[ERROR]3:-Dlibrary.jansi.path=C:\\\\Tools\\\\apache-maven-3.8.3\\\\lib\\\\jansi-native\\r\\n[ERROR]4:-Dmaven.multiModuleProjectDirectory=C:\\\\repositories\\\\IdeaProjects\\r\\n\\\\muse-ng\\\\td-ms\\r\\n[ERROR]BootClassPathSupported:false\\r\\n```\\r\\n\\r\\nMyPITconfigurationis\\r\\n```\\r\\n<groupId>org.pitest</groupId>\\r\\n<artifactId>pitest-maven</artifactId>\\r\\n<version>1.10.4</version>\\r\\n<dependencies>\\r\\n<dependency>\\r\\n<groupId>org.pitest</groupId>\\r\\n<artifactId>pitest-junit5-plugin</artifactId>\\r\\n<version>1.1.2</version>\\r\\n</dependency>\\r\\n</dependencies>\\r\\n```\\r\\nandIusejunit5.9.2\\r\\n\\r\\nPitestisconfiguredinalibraryonwhichIhavenoproblem.Butthislibraryisthebaseofallmymicroservicesandtheproblemoccursonallofthem.\\r\\nI'veusedPITestonversions1.8.xwithoutproblem.ThiserrorappearswhenItrytoupgradethetooltoversion1.9.xor1.10.x(thistraceisfromversion1.10.4)\\r\\n\",\"state\":\"open\",\"created_at\":\"2023-01-19T14:31:45Z\",\"updated_at\":\"2023-01-19T14:31:45Z\",\"closed_at\":null,\"labels\":[],\"author\":{\"id\":\"120655075\",\"username\":\"GerardSimon77\",\"name\":null,\"avatar_url\":\"https://avatars.githubusercontent.com/u/120655075?v=4\",\"web_url\":\"https://api.github.com/users/GerardSimon77\"},\"assignee\":null,\"votes\":0,\"comments\":[]},{\"id\":\"1538006305\",\"title\":\"Testorder\",\"description\":null,\"state\":\"closed\",\"created_at\":\"2023-01-18T13:28:38Z\",\"updated_at\":\"2023-01-18T13:28:49Z\",\"closed_at\":\"2023-01-18T13:28:49Z\",\"labels\":[],\"author\":{\"id\":\"24887294\",\"username\":\"pzzpl\",\"name\":\"cnlzp\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/24887294?v=4\",\"web_url\":\"https://api.github.com/users/pzzpl\"},\"assignee\":null,\"votes\":0,\"comments\":[]},{\"id\":\"1537933904\",\"title\":\"FixspellingerrorinComputClassWriter\",\"description\":null,\"state\":\"closed\",\"created_at\":\"2023-01-18T12:39:44Z\",\"updated_at\":\"2023-01-20T18:17:13Z\",\"closed_at\":\"2023-01-20T18:17:09Z\",\"labels\":[],\"author\":{\"id\":\"1671931\",\"username\":\"davidburstrom\",\"name\":null,\"avatar_url\":\"https://avatars.githubusercontent.com/u/1671931?v=4\",\"web_url\":\"https://api.github.com/users/davidburstrom\"},\"assignee\":null,\"votes\":0,\"comments\":[{\"id\":\"1398766669\",\"body\":\"Thanks!\",\"author\":{\"id\":\"1891135\",\"username\":\"hcoles\",\"name\":\"HenryColes\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/1891135?v=4\",\"web_url\":\"https://api.github.com/users/hcoles\"},\"created_at\":\"2023-01-20T18:17:13Z\",\"updated_at\":\"2023-01-20T18:17:13Z\"}]},{\"id\":\"1532442155\",\"title\":\"falsepositiveonorElseThrow()method.\",\"description\":\"I'mfacingapositivefalsewhenIusethemethode`orElseThrow()`from`java.util.Optional`object.\\r\\n\\r\\nPitestreplacesthereturnedvaluewithanullbutthe`orElseThrow()`methodcan'treturnanullvalue.\\r\\n\\r\\n![image](https://user-images.githubusercontent.com/120655075/212349586-97f175f3-a4ee-4588-a5dc-1dca42867ec4.png)\\r\\n\\r\\nI'mcurrentlyusingversion1.8.1ofPitest\",\"state\":\"closed\",\"created_at\":\"2023-01-13T15:05:03Z\",\"updated_at\":\"2023-01-19T13:42:48Z\",\"closed_at\":\"2023-01-19T13:42:48Z\",\"labels\":[],\"author\":{\"id\":\"120655075\",\"username\":\"GerardSimon77\",\"name\":null,\"avatar_url\":\"https://avatars.githubusercontent.com/u/120655075?v=4\",\"web_url\":\"https://api.github.com/users/GerardSimon77\"},\"assignee\":null,\"votes\":0,\"comments\":[{\"id\":\"1382028186\",\"body\":\"Pitesthasreplacedthereturnvalueofthelambdadefinedonline26withnull.Theequivalentcodewouldbe\\r\\n\\r\\n```java\\r\\nopt.orElseThrow(()->null);\\r\\n```\\r\\n\\r\\nWhilethisisnotthemostusefulmutation,itisvalid.Todetectityouwouldneedtoincludeatestcasewhere`findByHumanResource`returnedanemptyOptional.\\r\\n\\r\\nYoumightbeinterestedinthe[arcmutatebaseplugin](https://www.arcmutate.com/)whichimprovesthedescriptionsofmutationstolambdassotheyareeasiertounderstand.\\r\\n\",\"author\":{\"id\":\"1891135\",\"username\":\"hcoles\",\"name\":\"HenryColes\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/1891135?v=4\",\"web_url\":\"https://api.github.com/users/hcoles\"},\"created_at\":\"2023-01-13T15:37:05Z\",\"updated_at\":\"2023-01-13T15:37:18Z\"},{\"id\":\"1382170324\",\"body\":\"Thanksyouforyourquikreply,butIhaveanotherquestion.\\r\\n\\r\\nInthefollowingexampleIdon'tinderstandwhyPitestdoesn'ttrysomemutationonline34.Forexamplewhyitdoesn'ttrytoremovethiscalllikeitisdoneforlines32and33?\\r\\n\\r\\n![image](https://user-images.githubusercontent.com/120655075/212380616-c4ab3ea7-763e-4a3b-b868-d8238adf2bf2.png)\\r\\n\",\"author\":{\"id\":\"120655075\",\"username\":\"GerardSimon77\",\"name\":null,\"avatar_url\":\"https://avatars.githubusercontent.com/u/120655075?v=4\",\"web_url\":\"https://api.github.com/users/GerardSimon77\"},\"created_at\":\"2023-01-13T17:30:25Z\",\"updated_at\":\"2023-01-13T17:30:25Z\"},{\"id\":\"1382216587\",\"body\":\"Assumingyouareusingthedefaultoperators,the[VOID_METHOD_CALLS](https://pitest.org/quickstart/mutators/#VOID_METHOD_CALLS)mutatorwillbeactive,butthe[NON_VOID_METHOD_CALLS](https://pitest.org/quickstart/mutators/#NON_VOID_METHOD_CALLS)mutatorwillnotbeactivated.Thecalltothesavemethodisthereforenotmutatedasitreturnsavalue.\\r\\n\\r\\nYoucanactivatetheNON_VOID_METHOD_CALLSmutator,butbeawarethereisatradeofftobemadehere.Itwillgeneratearelativelylargenumberofmutantsandtheywilloftennotaddmuchvalueastheyarelessstablethanthenonvoidones.\",\"author\":{\"id\":\"1891135\",\"username\":\"hcoles\",\"name\":\"HenryColes\",\"avatar_url\":\"https://avatars.githubusercontent.com/u/1891135?v=4\",\"web_url\":\"https://api.github.com/users/hcoles\"},\"created_at\":\"2023-01-13T18:15:51Z\",\"updated_at\":\"2023-01-13T18:15:51Z\"}]}]}";
        project = mapper.readValue(projectData, Project.class);
        projectRepository.save(project);
    }

    @Test
    @DisplayName("Create a project")
    void create() {
        Project newProject = this.projectController.create(project);
        assertNotNull(newProject, "The created project should not be null");
        assertEquals(project.getId(), newProject.getId(), "The project id should be the same");
    }

    @Test
    @DisplayName("Find all projects")
    void findAll() {
        List<Project> projects = this.projectController.findAll(0, 10, null, null);
        assertNotNull(projects, "The project list should not be null");
        assertFalse(projects.isEmpty(), "The project list should not be empty") ;
    }

    @Test
    @DisplayName("Find one project by ID")
    void findOne() throws NotFoundException {
        Project foundProject = projectController.findOne(project.getId());
        assertNotNull(foundProject, "The project should not be null");
        assertEquals(project.getId(), foundProject.getId(), "The project id should be the same");
    }

    @Test
    @DisplayName("Update a project")
    void update() throws NotFoundException {
        Project updatedProject = new Project(
                project.getId(),
                "Updated Project Name",
                project.getWeb_url(),
                project.getCommits(),
                project.getIssues()
        );

        projectController.update(project.getId(), updatedProject);
        Project foundProject = projectController.findOne(project.getId());
        assertEquals("Updated Project Name", foundProject.getName(),
                "The project name should be updated");
    }

    @Test
    @DisplayName("Delete a project")
    void delete() throws NotFoundException {
        projectController.delete(project.getId());
        List<Project> projects = this.projectController.findAll(0, 10, null, null);
        assertTrue(projects.stream().noneMatch(p -> p.getId().equals(project.getId())),
                "The deleted project should no longer be present in the list");

    }
}